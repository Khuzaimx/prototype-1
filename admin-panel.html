<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClassAlarm Admin Panel</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/javascript">
      const { useState, useEffect } = React;

      // API Configuration
      const API_BASE_URL = 'http://localhost:8000/api';
      
      // API Helper Functions
      const apiCall = async (endpoint, options = {}) => {
        const url = `${API_BASE_URL}${endpoint}`;
        const token = localStorage.getItem('access_token');
        
        const config = {
          headers: {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` }),
          },
          ...options,
        };
        
        try {
          const response = await fetch(url, config);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || data.detail || 'API Error');
          }
          
          return data;
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      };

      function AdminLoginScreen({ onLogin }) {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setLoading(true);
          setError('');
          
          try {
            const data = await apiCall('/auth/login/', {
              method: 'POST',
              body: JSON.stringify({ email, password }),
            });
            
            // Check if user is admin
            if (!data.user.is_staff && !data.user.is_superuser) {
              throw new Error('Access denied. Admin privileges required.');
            }
            
            localStorage.setItem('access_token', data.tokens.access);
            localStorage.setItem('refresh_token', data.tokens.refresh);
            localStorage.setItem('admin_user', JSON.stringify(data.user));
            
            onLogin(data.user);
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        return (
          React.createElement('div', { className: 'min-h-screen flex items-center justify-center px-4' },
            React.createElement('div', { className: 'w-full max-w-md bg-white rounded-lg shadow p-8 space-y-6' },
              React.createElement('div', { className: 'text-center' },
                React.createElement('h1', { className: 'text-3xl font-bold text-gray-900' }, 'ClassAlarm'),
                React.createElement('h2', { className: 'text-xl font-semibold text-gray-700 mt-2' }, 'Admin Panel'),
                React.createElement('p', { className: 'text-sm text-gray-500 mt-1' }, 'Sign in with admin credentials')
              ),
              React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
                React.createElement('div', null,
                  React.createElement('label', { htmlFor: 'email', className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Email'),
                  React.createElement('input', {
                    id: 'email', type: 'email', value: email, onChange: (e) => setEmail(e.target.value),
                    placeholder: 'admin@giki.edu.pk',
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500',
                    disabled: loading
                  })
                ),
                React.createElement('div', null,
                  React.createElement('label', { htmlFor: 'password', className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Password'),
                  React.createElement('input', {
                    id: 'password', type: 'password', value: password, onChange: (e) => setPassword(e.target.value),
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500',
                    disabled: loading
                  })
                ),
                error && React.createElement('div', { className: 'text-sm text-red-600 bg-red-50 p-3 rounded-md' }, error),
                React.createElement('button', { 
                  type: 'submit', 
                  className: `w-full px-4 py-2 rounded-md font-medium ${loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'} text-white`,
                  disabled: loading
                }, loading ? 'Signing in...' : 'Sign In')
              ),
              React.createElement('div', { className: 'text-xs text-gray-500 text-center' },
                React.createElement('p', null, 'Only @giki.edu.pk emails allowed'),
                React.createElement('p', null, 'Admin privileges required')
              )
            )
          )
        );
      }

      function CRAssignmentPanel({ assignments, setAssignments }) {
        const [newEmail, setNewEmail] = useState('');
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');

        const handleAssignCR = async (e) => {
          e.preventDefault();
          setLoading(true);
          setError('');
          
          try {
            const data = await apiCall('/auth/admin/assign-cr/', {
              method: 'POST',
              body: JSON.stringify({ email: newEmail }),
            });
            
            setAssignments(prev => [data, ...prev]);
            setNewEmail('');
            alert('CR role assigned successfully!');
          } catch (err) {
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };

        const handleRevokeCR = async (email) => {
          if (!confirm(`Are you sure you want to revoke CR role from ${email}?`)) return;
          
          try {
            await apiCall('/auth/admin/revoke-cr/', {
              method: 'POST',
              body: JSON.stringify({ email }),
            });
            
            setAssignments(prev => prev.map(a => 
              a.email === email ? { ...a, is_active: false } : a
            ));
            alert('CR role revoked successfully!');
          } catch (err) {
            alert('Error revoking CR role: ' + err.message);
          }
        };

        return (
          React.createElement('div', { className: 'space-y-6' },
            React.createElement('div', { className: 'bg-white rounded-lg shadow p-6' },
              React.createElement('h2', { className: 'text-xl font-semibold text-gray-900 mb-6' }, 'Assign CR Role'),
              error && React.createElement('div', { className: 'mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-600 text-sm' }, error),
              React.createElement('form', { onSubmit: handleAssignCR, className: 'space-y-4' },
                React.createElement('div', null,
                  React.createElement('label', { htmlFor: 'cr-email', className: 'block text-sm font-medium text-gray-700 mb-2' }, 'GIKI Email'),
                  React.createElement('input', {
                    id: 'cr-email', type: 'email', value: newEmail, onChange: (e) => setNewEmail(e.target.value),
                    placeholder: 'student@giki.edu.pk',
                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500',
                    disabled: loading
                  }),
                  React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'Only @giki.edu.pk emails are allowed')
                ),
                React.createElement('button', { 
                  type: 'submit', 
                  className: `w-full px-4 py-2 rounded-md font-medium ${loading ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'} text-white`,
                  disabled: loading
                }, loading ? 'Assigning...' : 'Assign CR Role')
              )
            ),
            React.createElement('div', { className: 'bg-white rounded-lg shadow p-6' },
              React.createElement('h2', { className: 'text-xl font-semibold text-gray-900 mb-6' }, 'CR Assignments'),
              assignments.length === 0
                ? React.createElement('p', { className: 'text-gray-500 text-center py-8' }, 'No CR assignments yet.')
                : React.createElement('div', { className: 'space-y-3' },
                    assignments.map(assignment => (
                      React.createElement('div', { key: assignment.id, className: 'border border-gray-200 rounded-lg p-4' },
                        React.createElement('div', { className: 'flex justify-between items-center' },
                          React.createElement('div', null,
                            React.createElement('h3', { className: 'text-lg font-medium text-gray-900' }, assignment.email),
                            React.createElement('div', { className: 'text-sm text-gray-600' },
                              React.createElement('span', { className: 'inline-flex items-center' }, 'ðŸ‘¤ Assigned by: ', assignment.assigned_by),
                              React.createElement('span', { className: 'mx-2' }, 'â€¢'),
                              React.createElement('span', { className: 'inline-flex items-center' }, 'ðŸ“… ', new Date(assignment.assigned_at).toLocaleDateString())
                            ),
                            React.createElement('div', { className: 'mt-2' },
                              React.createElement('span', { 
                                className: `inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${assignment.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`
                              }, assignment.is_active ? 'âœ“ Active' : 'âœ— Inactive')
                            )
                          ),
                          React.createElement('div', { className: 'flex gap-2' },
                            assignment.is_active && React.createElement('button', { 
                              onClick: () => handleRevokeCR(assignment.email), 
                              className: 'px-3 py-1.5 text-sm rounded-md border border-red-200 text-red-600 hover:bg-red-50' 
                            }, 'Revoke')
                          )
                        )
                      )
                    ))
                  )
            )
          )
        );
      }

      function AdminPanel() {
        const [session, setSession] = useState(() => {
          try { 
            const user = localStorage.getItem('admin_user');
            return user ? JSON.parse(user) : null;
          } catch (_) { 
            return null; 
          }
        });
        const [assignments, setAssignments] = useState([]);
        const [loading, setLoading] = useState(false);

        // Load CR assignments on component mount
        useEffect(() => {
          if (session) {
            loadAssignments();
          }
        }, [session]);

        const loadAssignments = async () => {
          setLoading(true);
          try {
            const data = await apiCall('/auth/admin/cr-list/');
            setAssignments(data);
          } catch (err) {
            console.error('Error loading assignments:', err);
            setAssignments([]);
          } finally {
            setLoading(false);
          }
        };

        const handleLogin = (user) => {
          setSession(user);
        };

        const handleLogout = () => {
          setSession(null);
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          localStorage.removeItem('admin_user');
        };

        return (
          React.createElement('div', { className: 'min-h-screen bg-gray-50' },
            React.createElement('header', { className: 'bg-white shadow-sm border-b' },
              React.createElement('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8' },
                React.createElement('div', { className: 'flex justify-between items-center h-16' },
                  React.createElement('h1', { className: 'text-2xl font-bold text-gray-900' }, 'ClassAlarm Admin'),
                  React.createElement('div', { className: 'flex items-center gap-3' },
                    session && React.createElement('span', { className: 'text-sm text-gray-600' }, session.email, ' Â· Admin'),
                    session && React.createElement('button', { onClick: handleLogout, className: 'px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-50' }, 'Sign out')
                  )
                )
              )
            ),
            session
              ? React.createElement('main', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8' },
                  loading && React.createElement('div', { className: 'text-center py-8' }, 'Loading...'),
                  !loading && React.createElement(CRAssignmentPanel, { assignments, setAssignments })
                )
              : React.createElement(AdminLoginScreen, { onLogin: handleLogin })
          )
        );
      }

      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(React.createElement(React.StrictMode, null, React.createElement(AdminPanel)));
    </script>
  </body>
</html>
